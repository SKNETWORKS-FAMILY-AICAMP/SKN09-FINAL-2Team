CREATE USER 'user123'@'%' IDENTIFIED BY 'user123';

CREATE DATABASE `senpick_db` CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;
GRANT ALL PRIVILEGES ON `senpick_db`.* TO 'user123'@'%';
FLUSH PRIVILEGES;

USE senpick_db;

DROP TABLE IF EXISTS `user`;
CREATE TABLE `user` (
    `USER_ID` CHAR(32) NOT NULL,
    `EMAIL` VARCHAR(255) NOT NULL UNIQUE,
    `PASSWORD` VARCHAR(255) NOT NULL,
    `NICKNAME` VARCHAR(30) NOT NULL,
    `BIRTH` CHAR(8) NOT NULL,
    `GENDER` VARCHAR(8) NOT NULL,
    `JOB` VARCHAR(50),
    `PROFILE_IMAGE` VARCHAR(255) DEFAULT NULL,
    `TYPE` VARCHAR(10) NOT NULL DEFAULT 'guest',
    `SOCIAL_PROVIDER` VARCHAR(10) DEFAULT NULL,
    `IS_EMAIL_VERIFIED` BOOLEAN NOT NULL DEFAULT FALSE,
    `CREATED_AT` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `UPDATED_AT` DATETIME DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`USER_ID`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `chat`;
CREATE TABLE `chat` (
    `CHAT_ID` INT UNSIGNED NOT NULL AUTO_INCREMENT,
    `USER_ID` CHAR(32) NOT NULL,
    `TITLE` VARCHAR(100) NOT NULL,
    `CREATED_AT` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `IS_DELETED` BOOLEAN NOT NULL DEFAULT FALSE,
    PRIMARY KEY (`CHAT_ID`),
    CONSTRAINT `FK_CHAT_USER_ID` FOREIGN KEY (`USER_ID`) REFERENCES `user` (`USER_ID`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `chat_msg`;
CREATE TABLE `chat_msg` (
    `MSG_ID` INT UNSIGNED NOT NULL AUTO_INCREMENT,
    `CHAT_ID` INT UNSIGNED NOT NULL,
    `SENDER` VARCHAR(20) NOT NULL,
    `MESSAGE` TEXT NOT NULL,
    `CREATED_AT` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (`MSG_ID`),
    CONSTRAINT `FK_CHAT_MESSAGE_CHAT_ID` FOREIGN KEY (`CHAT_ID`) REFERENCES `chat` (`CHAT_ID`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `recipient`;
CREATE TABLE `recipient` (
    `CHAT_ID` INT UNSIGNED NOT NULL,
    `GENDER` CHAR(8) NOT NULL,
    `AGE_GROUP` VARCHAR(20) NOT NULL,
    `RELATION` VARCHAR(20) DEFAULT NULL,
    `ANNIVERSARY` VARCHAR(50) DEFAULT NULL,
    `SITUATION_INFO` TEXT DEFAULT NULL,
    `CREATED_AT` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (`CHAT_ID`),
    CONSTRAINT `FK_RECIPIENT_INFO_CHAT_ID` FOREIGN KEY (`CHAT_ID`) REFERENCES `chat` (`CHAT_ID`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `product`;
CREATE TABLE `product` (
    `PRODUCT_ID` INT UNSIGNED NOT NULL AUTO_INCREMENT,
    `NAME` VARCHAR(255) NOT NULL,
    `IMAGE_URL` VARCHAR(255) DEFAULT NULL,
    `PRICE` DECIMAL(10, 2) NOT NULL,
    `DESCRIPTION` TEXT,
    `CATEGORY` VARCHAR(50) NOT NULL,
    `PRODUCT_URL` VARCHAR(255) DEFAULT NULL,
    `IS_RECOMMENDED` BOOLEAN DEFAULT FALSE,
    `CREATED_AT` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `UPDATED_AT` DATETIME DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`PRODUCT_ID`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `chat_rcmd`;
CREATE TABLE `chat_rcmd` (
    `RCMD_ID` INT UNSIGNED NOT NULL AUTO_INCREMENT,
    `CHAT_ID` INT UNSIGNED NOT NULL,
    `PRODUCT_ID` INT UNSIGNED NOT NULL,
    `IS_LIKED` BOOLEAN NOT NULL DEFAULT FALSE,
    `CREATED_AT` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (`RCMD_ID`),
    CONSTRAINT `FK_RCMD_CHAT_ID` FOREIGN KEY (`CHAT_ID`) REFERENCES `chat` (`CHAT_ID`) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT `FK_RCMD_PRODUCT_ID` FOREIGN KEY (`PRODUCT_ID`) REFERENCES `product` (`PRODUCT_ID`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `prefer_type`;
CREATE TABLE `prefer_type` (
    `PREFER_ID` INT UNSIGNED NOT NULL AUTO_INCREMENT,
    `TYPE` VARCHAR(20) NOT NULL,
    `TYPE_NAME` VARCHAR(100) NOT NULL,
    PRIMARY KEY (`PREFER_ID`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `user_prefer`;
CREATE TABLE `user_prefer` (
    `USER_ID` CHAR(32) NOT NULL,
    `PREFER_ID` INT UNSIGNED NOT NULL,
    `CREATED_AT` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `UPDATED_AT` DATETIME DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
    CONSTRAINT `FK_USER_PREF_USER` FOREIGN KEY (`USER_ID`) REFERENCES `user` (`USER_ID`) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT `FK_USER_PREF_TYPE` FOREIGN KEY (`PREFER_ID`) REFERENCES `prefer_type` (`PREFER_ID`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `feedback`;
CREATE TABLE `feedback` (
    `MSG_ID` INT UNSIGNED NOT NULL UNIQUE,
    `FEEDBACK` BOOLEAN NOT NULL,
    `CREATED_AT` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `UPDATED_AT` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    CONSTRAINT `FK_FEEDBACK_MSG_ID` FOREIGN KEY (`MSG_ID`) REFERENCES `chat_msg` (`MSG_ID`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 선호 스타일
INSERT INTO prefer_type (`TYPE`, `TYPE_NAME`) VALUES
('스타일', '감성적'),
('스타일', '실용적'),
('스타일', '트렌디'),
('스타일', '미니멀'),
('스타일', '럭셔리'),
('스타일', '유니크'),
('스타일', '자연친화'),
('스타일', '클래식');

-- 선호 카테고리
INSERT INTO prefer_type (`TYPE`, `TYPE_NAME`) VALUES
('카테고리', '식품'),
('카테고리', '뷰티'),
('카테고리', '패션'),
('카테고리', '반려동물'),
('카테고리', '교환권'),
('카테고리', '건강·케어'),
('카테고리', '아기·어린이'),
('카테고리', '레저·자동차'),
('카테고리', '디지털·가전'),
('카테고리', '프리미엄 선물'),
('카테고리', '리빙·인테리어');


-- product_like_summary view
DROP VIEW IF EXISTS `product_like_summary`;
CREATE VIEW `product_like_summary` AS
SELECT
    p.PRODUCT_ID,
    p.NAME,
    COUNT(r.RCMD_ID) AS LIKE_COUNT
FROM product p
LEFT JOIN chat_rcmd r ON p.PRODUCT_ID = r.PRODUCT_ID AND r.IS_LIKED = TRUE
GROUP BY p.PRODUCT_ID, p.NAME;