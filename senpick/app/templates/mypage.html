{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Page</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="stylesheet" href="{% static 'css/mypage.css' %}">
  <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Spoqa+Han+Sans+Neo:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cafe24+Supermagic&display=swap" rel="stylesheet">
</head>
<body>
  <div style="display: flex;" class="layout">
    {% include 'layout/sidebar.html' %}

    <div class="mypage-container">
      <h1 class="mypage-title">My Page</h1>
      <div class="mypage-grid">

        <!-- 프로필 영역 -->
        <section class="profile-section">
          <h2 class="section-title">프로필</h2>
          <div class="profile-card">
            <div class="profile-row">
              <img src="{% if profile.profile_image %}{{ profile.profile_image }}{% else %}{% static 'images/member_default_image.png' %}{% endif %}" alt="profile" class="profile-image-horizontal">
              <div class="profile-info-text">
                <p class="profile-name">{{ profile.nickname }}</p>
                <p class="profile-email">{{ profile.email }}</p>
              </div>
            </div>
            <div class="tag-list">
              {% for tag in prefer_tags %}
                <span class="tag">{{ tag }}</span>
              {% empty %}
                <span class="tag">선호 태그 없음</span>
              {% endfor %}
            </div>
            <a href="{% url 'profile_info' %}">
              <button class="edit-btn">프로필 수정</button>
            </a>
          </div>
        </section>

        <!-- 좋아요 히스토리 영역 -->
        <section class="like-section">
          <h2 class="section-title">좋아요 히스토리</h2>

          {% if history_data %}
            {% for chat, recipient, products in history_data %}
              <div class="like-block" data-chat_id="{{ chat.CHAT_ID }}">
                <div class="like-card" onclick="toggleLikeBlock(this)">
                  <div class="like-row">
                    <div class="left">
                      <p class="like-title-text">{{ chat.TITLE }}</p>
                      <div class="like-tags">
                        {% if recipient %}
                          {% if recipient.RELATION %}<span>{{ recipient.RELATION }}</span>{% endif %}
                          {% if recipient.AGE_GROUP %}<span>{{ recipient.AGE_GROUP }}</span>{% endif %}
                          {% if recipient.GENDER %}<span>{{ recipient.GENDER }}</span>{% endif %}
                          {% if recipient.ANNIVERSARY %}<span>{{ recipient.ANNIVERSARY }}</span>{% endif %}
                        {% endif %}
                      </div>
                    </div>
                    <div class="right">
                      <div class="like-count">💛 {{ products|length }}</div>
                      <div class="like-meta">{{ chat.CREATED_AT|date:"n월 j일의 고민" }}</div>
                    </div>
                  </div>
                </div>
                <div class="product-scroll-wrapper hidden">
                  <div class="card-wrapper"></div>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <p class="no-history-text">아직 좋아요한 선물이 없습니다.</p>
          {% endif %}
        </section>

      </div>
    </div>
  </div>

  <!-- JS용 product 데이터 정의 -->
  <script>
    window.productMap = {
      {% for chat, recipient, products in history_data %}
        "{{ chat.CHAT_ID }}": [
          {% for product in products %}
            {
              imageUrl: "{{ product.thumbnail_url }}",
              brand: "{{ product.brand_name }}",
              title: "{{ product.product_name }}",
              link: "{{ product.product_url }}",
              rcmd_id: "{{ product.product_id }}",
              is_liked: true,
              reason: "{{ product.reason|default:'' }}"
            }{% if not forloop.last %},{% endif %}
          {% endfor %}
        ]{% if not forloop.last %},{% endif %}
      {% endfor %}
    };
  </script>
  <script src="{% static 'js/script.js' %}"></script>
</body>
</html>
