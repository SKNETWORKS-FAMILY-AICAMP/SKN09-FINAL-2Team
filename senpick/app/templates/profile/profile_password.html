{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="stylesheet" href="{% static 'css/mypage.css' %}">
  <link rel="stylesheet" href="{% static 'css/profile_info.css' %}">
  <link rel="stylesheet" href="{% static 'css/sidebar_profile.css' %}">
  <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Spoqa+Han+Sans+Neo:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cafe24+Supermagic&display=swap" rel="stylesheet">
</head>
<body>
  <div style="display: flex;" class="layout">
    {% include "sidebar.html" %}

    <div class="layout">
      <!-- 좌측 서브 사이드바 -->
      <div class="sidebar-wrapper">
        {% include "profile/sidebar_profile.html" with active_tab="password" %}
      </div>

      <!-- 우측 프로필 수정 메인 영역 -->
      <div class="profile-main-wrapper">
        <div class="profile-main">
          <div class="profile-form">
            <form method="POST" action="">
              {% csrf_token %}
              <div style="text-align: center;">
                <h1 class="mypage-title">비밀번호 재설정</h1>
                <p class="mypage-subtitle">새롭게 사용할 비밀번호를 설정해주세요.</p>
              </div>

              <label>현재 비밀번호 확인</label>
              <div style="display: flex;">
                <input type="password" placeholder="비밀번호 입력" id="current-password"
                       oninput="validateCurrentPassword()" onblur="validateCurrentPassword()">
                <div class="submit-button" style="margin-top:0; width: 110px; margin-left: 10px;">
                  <button type="button" id="check-password-btn" onclick="checkPWD()">확인</button>
                </div>
              </div>

              <label>새 비밀번호 설정</label>
              <input type="password" placeholder="비밀번호 입력" id="new-password"
                     oninput="validateNewPassword()" onblur="validateNewPassword()">

              <label>새 비밀번호 확인</label>
              <input type="password" placeholder="비밀번호 입력" id="confirm-password"
                     oninput="checkPasswordMatch()" onblur="checkPasswordMatch()">

              <div class="submit-button">
                <button type="submit">비밀번호 설정 완료</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.querySelector("form").onsubmit = function (event) {
      event.preventDefault();

      const validCurrent = validateCurrentPassword();
      const validNew = validateNewPassword();
      const validMatch = checkPasswordMatch();

      if (validCurrent && validNew && validMatch) {
        alert("비밀번호가 성공적으로 변경되었습니다.");
        window.location.href = "{% url 'profile_password_confirm' %}";
      }
    };

    function setError(el, message) {
      el.classList.add("error");
      let msg = document.createElement("p");
      msg.className = "error-message";
      msg.style.color = "#EB1C24";
      msg.style.fontSize = "13px";
      msg.style.marginTop = "6px";
      msg.textContent = message;
      el.insertAdjacentElement("afterend", msg);
    }

    function clearError(el) {
      el.classList.remove("error");
      if (el.nextElementSibling && el.nextElementSibling.className === "error-message") {
        el.nextElementSibling.remove();
      }
    }

    function validateCurrentPassword() {
      const currentPassword = document.getElementById("current-password");
      clearError(currentPassword.parentNode);

      if (!currentPassword.value) {
        setError(currentPassword.parentNode, "기존의 비밀번호를 입력해주세요.");
        return false;
      }

      if (currentPassword.value.length < 8) {
        setError(currentPassword.parentNode, "비밀번호는 최소 8자 이상이어야 합니다.");
        return false;
      }

      return true;
    }

    function validateNewPassword() {
      const newPassword = document.getElementById("new-password");
      const currentPassword = document.getElementById("current-password");
      clearError(newPassword);

      if (!newPassword.value) {
        setError(newPassword, "새로운 비밀번호를 입력해주세요. *영문 소문자, 숫자를 이용하여 최소 8~15자리");
        return false;
      }

      const pwRegex = /^(?=.*[a-z])(?=.*[0-9])[a-z0-9]{8,15}$/;
      if (!pwRegex.test(newPassword.value)) {
        setError(newPassword, "새로운 비밀번호를 입력해주세요. *영문 소문자, 숫자를 이용하여 최소 8~15자리");
        return false;
      }

      if (newPassword.value === currentPassword.value) {
        setError(newPassword, "이전 비밀번호입니다.");
        return false;
      }

      return true;
    }

    function checkPasswordMatch() {
      const pw1 = document.getElementById("new-password");
      const pw2 = document.getElementById("confirm-password");
      clearError(pw2);

      if (pw2.value && pw1.value !== pw2.value) {
        setError(pw2, "비밀번호가 일치하지 않습니다.");
        return false;
      }

      return true;
    }

    function checkPWD() {
      const currentPassword = document.getElementById('current-password');
      const checkButton = document.querySelector('#check-password-btn');
      clearError(currentPassword.parentNode);

      if (!currentPassword.value) {
        setError(currentPassword.parentNode, "기존의 비밀번호를 입력해주세요.");
        return;
      }

      if (currentPassword.value !== "비밀번호정답") { // 실제 서버 검증 필요
        setError(currentPassword.parentNode, "기존의 비밀번호와 일치하지 않습니다.");
        return;
      }

      alert("현재 비밀번호가 확인되었습니다.");
      currentPassword.disabled = true;
      checkButton.disabled = true;
      checkButton.style.opacity = '0.5';
      checkButton.style.cursor = 'not-allowed';
    }
  </script>
</body>
</html>
