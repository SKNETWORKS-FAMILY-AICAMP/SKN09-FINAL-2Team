{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/mypage.css' %}">
    <link rel="stylesheet" href="{% static 'css/profile_info.css' %}">
    <link rel="stylesheet" href="{% static 'css/sidebar_profile.css' %}">
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Spoqa+Han+Sans+Neo:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cafe24+Supermagic&display=swap" rel="stylesheet">
</head>
<body>
    <div style="display: flex;" class="layout">
        {% include "sidebar.html" %}

        <div class="layout">
          <!-- 좌측 서브 사이드바 -->
          <div class="sidebar-wrapper">
            {% include "profile/sidebar_profile.html" with active_tab="password" %}
          </div>

          <!-- 우측 프로필 수정 메인 영역 -->
          <div class="profile-main-wrapper">
            <div class="profile-main">
              <div class="profile-form">
                <form method="POST" action="">
                  {% csrf_token %}
                  <div style="text-align: center;">
                    <h1 class="mypage-title">비밀번호 재설정</h1>
                    <p class="mypage-subtitle">새롭게 사용할 비밀번호를 설정해주세요.</p>
                  </div>

                  <label>현재 비밀번호 확인</label>
                  <div style="display: flex;">
                    <input type="password" placeholder="비밀번호 입력" id="current-password">
                    <div class="submit-button" style="margin-top:0; width: 110px; margin-left: 10px;">
                      <button type="button" onclick="checkPWD()">확인</button>
                    </div>
                  </div>

                  <label>새 비밀번호 설정</label>
                  <input type="password" placeholder="비밀번호 입력" id="new-password" onchange="checkPasswordMatch()">
                  <label>새 비밀번호 확인</label>
                  <input type="password" placeholder="비밀번호 입력" id="confirm-password" onchange="checkPasswordMatch()">
                  <div class="submit-button">
                    <button type="submit">비밀번호 설정 완료</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
    </div>
    <script>
      document.getElementsByTagName('form')[0].onsubmit = function(event) {
        event.preventDefault(); // 폼 제출 방지
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;

        if (newPassword !== confirmPassword) {
          alert('새 비밀번호와 확인 비밀번호가 일치하지 않습니다.');
          return;
        }

        // 여기에 AJAX 요청 등을 추가하여 서버로 비밀번호 변경 요청을 보낼 수 있습니다.
        alert('비밀번호가 성공적으로 변경되었습니다.');
        window.location.href = "{% url 'profile_password_confirm' %}"; // 비밀번호 변경 후 확인 페이지로 이동
      };
      
      // ------------------------ 헬퍼 함수 ------------------------
      function setError(el, message) {
        el.classList.add("error");
        let msg = document.createElement("p");
        msg.className = "error-message";
        msg.style.color = "#EB1C24";
        msg.style.fontSize = "13px";
        msg.style.marginTop = "6px";
        msg.textContent = message;
        el.insertAdjacentElement("afterend", msg);
      }

      function clearError(el) {
        el.classList.remove("error");
        if (el.nextElementSibling && el.nextElementSibling.className === "error-message") {
          el.nextElementSibling.remove();
        }
      }

      function checkPWD() {
        const currentPassword = document.getElementById('current-password');
        clearError(currentPassword.parentNode);
        currentPassword.classList.remove("error");
        if (currentPassword.value === "") {
          currentPassword.classList.add("error");
          setError(currentPassword.parentNode, "현재 비밀번호를 입력해주세요.");
        } else if (currentPassword.value.length < 8) {
          currentPassword.classList.add("error");
          setError(currentPassword.parentNode, "비밀번호는 최소 8자 이상이어야 합니다.");
        } else {
          // 여기에 AJAX 요청 등을 추가하여 현재 비밀번호 확인을 서버에 요청할 수 있습니다.
          alert("현재 비밀번호가 확인되었습니다.");
        }
      }

      function checkPasswordMatch() {
        const pw1 = document.getElementById("new-password").value;
        const pw2 = document.getElementById("confirm-password").value;
        clearError(document.getElementById("confirm-password"));

        if (pw1 && pw2) {
          if (pw1 != pw2) {
            document.getElementById("confirm-password").style.borderColor = "red";
            setError(document.getElementById("confirm-password"), "비밀번호가 일치하지 않습니다.");
          } else {
            document.getElementById("confirm-password").style.borderColor = "";
          }
        } else {
          document.getElementById("confirm-password").style.borderColor = "";
        }
      }
    </script>
</body>
</html>
