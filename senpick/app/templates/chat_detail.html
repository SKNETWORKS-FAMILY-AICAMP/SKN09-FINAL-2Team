{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Senpick 챗봇</title>
  <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="stylesheet" href="{% static 'css/stepper.css' %}">
  <link rel="stylesheet" href="{% static 'css/chat.css' %}">
  <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
  <link rel="stylesheet" href="{% static 'css/sidebar2.css' %}">
  <script src="{% static 'js/script.js' %}"></script>
</head>
<body>
  <div class="app-layout">
    {% include 'layout/sidebar.html' %}
    <div class="main-content">
      <div class="chatbot-body">
        <div class="chat-window" id="chat-history">
          <div class="chat-msg user">
            🎁 {{ recipient_info.gender }} / {{ recipient_info.age_group }} / {{ recipient_info.relation }} / {{ recipient_info.anniversary }}
          </div>
          {% for msg in messages %}
            {% if msg.sender == 'user' %}
              <div class="chat-msg user">{{ msg.message }}</div>
            {% else %}
              <div class="chat-msg bot">{{ msg.message }}</div>
              {% if msg.products %}
                <div class="card-wrapper">
                  {% for product in msg.products %}
                    <div class="product-card">
                      <a href="{{ product.link }}" target="_blank">
                        <div class="image-wrapper">
                          <img src="{{ product.imageUrl }}" alt="{{ product.title }}">
                        </div>
                        <div class="product-info">
                          <div class="brand">{{ product.brand }}</div>
                          <div class="title">{{ product.title }}</div>
                        </div>
                      </a>
                      <div class="heart">
                        <img src="{% if product.is_liked %}/static/images/Heart_red.svg{% else %}/static/images/Heart_gray.svg{% endif %}" 
                             alt="Heart Icon" 
                             class="heart-icon {% if product.is_liked %}active{% endif %}"
                             data-recd_id="{{ product.recommend_id }}">
                      </div>
                      <div class="reason">추천 이유: {{ product.reason }}</div>
                    </div>
                  {% endfor %}
                </div>
                <div class="feedback-input">
                  {% if msg.feedback %}
                    {% if msg.feedback.feedback %}
                      <img src="/static/images/thumbs_up_selected.svg" alt="좋아요" class="thumbs-up-icon" data-feedback-target="{{ msg.msg_id }}" data-feedback-type="like" onclick="sendFeedback('{{ msg.msg_id }}', 'like', this)">
                      <img src="/static/images/thumbs_down.svg" alt="싫어요" class="thumbs-down-icon" data-feedback-target="{{ msg.msg_id }}" data-feedback-type="dislike" onclick="sendFeedback('{{ msg.msg_id }}', 'dislike', this)">
                    {% else %}
                      <img src="/static/images/thumbs_up.svg" alt="좋아요" class="thumbs-up-icon" data-feedback-target="{{ msg.msg_id }}" data-feedback-type="like" onclick="sendFeedback('{{ msg.msg_id }}', 'like', this)">
                      <img src="/static/images/thumbs_down_selected.svg" alt="싫어요" class="thumbs-down-icon" data-feedback-target="{{ msg.msg_id }}" data-feedback-type="dislike" onclick="sendFeedback('{{ msg.msg_id }}', 'dislike', this)">
                    {% endif %}
                  {% else %}
                    <img src="/static/images/thumbs_up.svg" alt="좋아요" class="thumbs-up-icon" data-feedback-target="{{ msg.msg_id }}" data-feedback-type="like" onclick="sendFeedback('{{ msg.msg_id }}', 'like', this)">
                    <img src="/static/images/thumbs_down.svg" alt="싫어요" class="thumbs-down-icon" data-feedback-target="{{ msg.msg_id }}" data-feedback-type="dislike" onclick="sendFeedback('{{ msg.msg_id }}', 'dislike', this)">
                  {% endif %}
                </div>
              {% endif %}
            {% endif %}
          {% endfor %}
        </div>
        <!-- 이전 채팅 내용을 볼 때는 채팅 입력창을 숨깁니다 -->
        <div class="chat-readonly-notice" id="chat-form" style="text-align: center; color: #666; margin-bottom: 20px;" data-chat-id="{{ chat.chat_id }}">
          이전 대화 내용입니다. 새로운 대화를 시작하려면 왼쪽 사이드바의 '새 채팅' 버튼을 클릭하세요.
        </div>
      </div>
    </div>
    {% include 'layout/sidebar2.html' %}
  </div>
  <script>
    // 5. 챗봇 대화 입력
    function chatInit() {
      const chatForm = document.getElementById('chat-form');
      const userInput = document.getElementById('user-input');
      const chatHistory = document.getElementById('chat-history');
      chatForm.onsubmit = function (e) {
        e.preventDefault();
        const userInput = document.getElementById('user-input');
        const msg = userInput.value.trim();
        if (msg !== "") {
          chatHistory.insertAdjacentHTML(
            'beforeend',
            `<div class="chat-msg user">${msg}</div>`
          );
          chatHistory.scrollTop = chatHistory.scrollHeight;

          // 로딩 표시
          chatHistory.insertAdjacentHTML(
            'beforeend',
            `<div class="chat-loading" id="chat-loading-spin" style="display:flex;align-items:center;gap:8px;margin:12px 0 12px 0;">
              <span style="display:inline-block;">
                <svg width="20" height="21" viewBox="0 0 20 21" fill="none" xmlns="http://www.w3.org/2000/svg" style="animation: spin 1s linear infinite;">
                  <path fill-rule="evenodd" clip-rule="evenodd" d="M19.0108 11.3956C19.5375 11.5617 19.8299 12.1233 19.6638 12.65L19.4146 13.4405L19.0807 14.2466L18.6778 15.0204L18.209 15.7563L17.6779 16.4485L17.0885 17.0917L16.4452 17.6811L15.753 18.2123L15.0172 18.681L14.282 19.0637C13.7922 19.3188 13.1883 19.1284 12.9333 18.6385C12.6783 18.1486 12.8687 17.5447 13.3585 17.2897L14.0163 16.9473L14.6048 16.5724L15.1584 16.1476L15.6729 15.6761L16.1444 15.1617L16.5692 14.608L16.9441 14.0195L17.2663 13.4005L17.5334 12.7558L17.7563 12.0486C17.9224 11.5219 18.484 11.2295 19.0108 11.3956Z" fill="#2E2E2E"/>
                  <path fill-rule="evenodd" clip-rule="evenodd" d="M19.0966 9.43368C18.5574 9.55321 18.0234 9.21301 17.9039 8.67382L17.7434 7.94991L17.5336 7.28438L17.2665 6.63967L16.9443 6.02069L16.5694 5.43215L16.1445 4.87853L15.6731 4.36404L15.1586 3.89259L14.605 3.46778L14.0164 3.09284L13.3975 2.77062L12.7528 2.50357L12.0872 2.29373L11.4059 2.14269L10.7141 2.05161L10.0169 2.02117L9.31976 2.05161L8.62791 2.14269L7.94662 2.29373L7.28109 2.50357L6.63638 2.77062L6.0174 3.09283L5.42886 3.46778L4.87523 3.89259L4.36074 4.36403L3.8893 4.87853L3.46449 5.43215L3.08955 6.02069L2.76732 6.63967L2.50028 7.28437L2.29044 7.94992L2.1394 8.6312L2.04832 9.32305L2.01788 10.0202L2.04831 10.7174L2.1394 11.4092L2.29044 12.0905L2.50028 12.756L2.76732 13.4008L3.08955 14.0197L3.46449 14.6083L3.8893 15.1619L4.36075 15.6764L4.87524 16.1478L5.42885 16.5726L6.01741 16.9476L6.63638 17.2698L7.28107 17.5369L7.94662 17.7467L8.6279 17.8977L9.31975 17.9888L10.0605 18.0212C10.6123 18.0453 11.0401 18.5121 11.016 19.0638C10.9919 19.6156 10.5251 20.0434 9.9733 20.0193L9.14528 19.9831L8.28028 19.8692L7.42849 19.6804L6.5964 19.418L5.79034 19.0842L5.01645 18.6813L4.28061 18.2125L3.58844 17.6814L2.94518 17.092L2.35575 16.4487L1.82462 15.7565L1.35584 15.0207L0.952983 14.2468L0.619104 13.4407L0.356747 12.6087L0.167908 11.7569L0.0540273 10.8919L0.0159709 10.0202L0.0540295 9.14857L0.167909 8.28357L0.356747 7.43178L0.619102 6.59969L0.952982 5.79363L1.35584 5.01974L1.82462 4.2839L2.35575 3.59173L2.94518 2.94847L3.58843 2.35904L4.28061 1.82791L5.01645 1.35914L5.79034 0.956275L6.5964 0.622394L7.42849 0.360038L8.28028 0.1712L9.14528 0.0573195L10.0169 0.0192628L10.8886 0.0573193L11.7536 0.1712L12.6054 0.360037L13.4374 0.622394L14.2435 0.956274L15.0174 1.35914L15.7532 1.82791L16.4454 2.35904L17.0887 2.94847L17.6781 3.59173L18.2092 4.2839L18.678 5.01974L19.0809 5.79363L19.4147 6.59969L19.6771 7.43178L19.8565 8.24094C19.976 8.78014 19.6358 9.31414 19.0966 9.43368Z" fill="#E0E0E0"/>
                </svg>
              </span>
              <span style="color: #616161;">챗봇의 응답을 기다리는 중....</span>
            </div>`
          );
          chatHistory.scrollTop = chatHistory.scrollHeight;
          const chatForm = document.getElementById("chat-form");
          userInput.disabled = true;
          // === 실제 백엔드 연결 ===
          fetch('/chat/message/', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ message: msg, chat_id: window.currentChatId })
          })
          .then(res => {
              const contentType = res.headers.get('Content-Type') || '';
              console.log(contentType)
              const loadingDiv = document.getElementById('chat-loading-spin');
              if (contentType.includes('text/plain')) {
                  if (loadingDiv) loadingDiv.remove();
                  chatForm.disabled = false
                  console.log("streaming text/plain response");
                  // 스트리밍 처리 - ReadableStream으로 처리
                  const reader = res.body.getReader();
                  const decoder = new TextDecoder('utf-8');
                  const chatHistory = document.getElementById('chat-history');  // 가정

                  // 1️⃣ 빈 bot div 먼저 추가
                  const botMsgDiv = document.createElement('div');
                  botMsgDiv.className = 'chat-msg bot';
                  botMsgDiv.innerHTML = ''; // 초기 빈 상태
                  chatHistory.appendChild(botMsgDiv);

                  function read() {
                      reader.read().then(({ done, value }) => {
                          if (done) {
                              console.log('Stream complete');
                              const loadingDiv = document.getElementById('chat-loading-spin');
                              return;
                          }

                          const chunk = decoder.decode(value, { stream: true });
                          console.log('Received chunk:', chunk);

                          // 화면에 실시간 추가
                          botMsgDiv.innerHTML += chunk;

                          chatHistory.scrollTop = chatHistory.scrollHeight;
                          setTimeout(() => {
                            read(); // 계속 읽기
                          }, 50);
                      });
                  }

                  read();
              }
              else if (contentType.includes('application/json')) {
                  // 기존 JSON 처리
                  return res.json().then(data => {
                    const loadingDiv = document.getElementById('chat-loading-spin');
                    if (loadingDiv) loadingDiv.remove();
                    chatForm.disabled = false;

                    const chatHistory = document.getElementById('chat-history');

                    // bot 응답 출력
                    if (data.bot) {
                        chatHistory.insertAdjacentHTML(
                            'beforeend',
                            `<div class="chat-msg bot">${data.bot}</div>`
                        );
                    }

                    // products 출력
                    if (data.products) {
                        const cardWrapper = document.createElement('div');
                        cardWrapper.className = 'card-wrapper';
                        cardWrapper.style.marginTop = '8px';
                        chatHistory.appendChild(cardWrapper);
                        for (const product of data.products) {
                            product.brand = product.brand || "";
                            createProductCard(cardWrapper, product);
                        }
                    }

                    // 기존 recommend 중복 제거
                    document.querySelectorAll('.recommend').forEach(el => el.remove());

                    // recommend 버튼 추가
                    const recommend = document.createElement('div');
                    recommend.className = 'recommend';

                    for (const recommend_input of data.recommend_inputs) {
                      const recommendBtn = document.createElement('button');
                      recommendBtn.textContent = recommend_input;
                      recommendBtn.onclick = function () {
                          document.getElementById('user-input').value = '다른 상품 추천해줘';
                          document.getElementById('chat-form').dispatchEvent(new Event('submit'));
                      };

                      recommend.appendChild(recommendBtn);
                    }
                    chatHistory.appendChild(recommend);

                    // feedback 버튼 추가
                    const feedbackInput = document.createElement('div');
                    feedbackInput.className = 'feedback-input';

                    const thumbsUp = document.createElement('img');
                    thumbsUp.src = '/static/images/thumbs_up.svg';
                    thumbsUp.alt = '좋아요';

                    const thumbsDown = document.createElement('img');
                    thumbsDown.src = '/static/images/thumbs_down.svg';
                    thumbsDown.alt = '싫어요';

                    feedbackInput.appendChild(thumbsUp);
                    feedbackInput.appendChild(thumbsDown);
                    chatHistory.appendChild(feedbackInput);

                    // thumbsUp 클릭 처리
                    thumbsUp.onclick = function () {
                        fetch(`/chat/feedback/${data.msg_id}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ feedback: 'like' })
                        }).then(response => {
                            if (response.ok) {
                                thumbsUp.src = '/static/images/thumbs_up_selected.svg';
                                thumbsDown.src = '/static/images/thumbs_down.svg'; // 초기화
                            } else {
                                console.error('Feedback failed');
                            }
                        }).catch(error => {
                            console.error('Network error', error);
                        });
                    };

                    // thumbsDown 클릭 처리
                    thumbsDown.onclick = function () {
                        fetch(`/chat/feedback/${data.msg_id}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ feedback: 'dislike' })
                        }).then(response => {
                            if (response.ok) {
                                thumbsDown.src = '/static/images/thumbs_down_selected.svg';
                                thumbsUp.src = '/static/images/thumbs_up.svg'; // 초기화
                            } else {
                                console.error('Feedback failed');
                            }
                        }).catch(error => {
                            console.error('Network error', error);
                        });
                    };
                  });
              }
              else {
                  throw new Error(`Unsupported Content-Type: ${contentType}`);
              }
          })
          .catch(error => {
              console.error('Fetch error:', error);
              const loadingDiv = document.getElementById('chat-loading-spin');
              if (loadingDiv) loadingDiv.remove();
              const chatHistory = document.getElementById('chat-history');
              chatHistory.insertAdjacentHTML(
                'beforeend',
                `<div class="chat-msg bot">오류가 발생했습니다. 다시 시도해주세요.</div>`
              );
              chatHistory.scrollTop = chatHistory.scrollHeight;
          })
          .finally(() => {
            chatHistory.scrollTop = chatHistory.scrollHeight;
            userInput.disabled = false;
            userInput.focus();
          });
        }
        userInput.value = '';
      }
    }

    function sendFeedback(msgId, feedback) {
      fetch(`/chat/feedback/${msgId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ feedback: feedback })
      })
      .then(response => {
        if (response.ok) {
          console.log(`Feedback ${feedback} sent for message ID ${msgId}`);
          // 1️⃣ 같은 message의 모든 thumbs 아이콘 찾기
          const thumbsUp = document.querySelector(`img[data-feedback-target="${msgId}"][data-feedback-type="like"]`);
          const thumbsDown = document.querySelector(`img[data-feedback-target="${msgId}"][data-feedback-type="dislike"]`);

          // 2️⃣ src 업데이트
          if (feedback === 'like') {
            thumbsUp.src = '/static/images/thumbs_up_selected.svg';
            thumbsDown.src = '/static/images/thumbs_down.svg';
          } else if (feedback === 'dislike') {
            thumbsUp.src = '/static/images/thumbs_up.svg';
            thumbsDown.src = '/static/images/thumbs_down_selected.svg';
          }
        } else {
          console.error('Feedback submission failed');
        }
      })
      .catch(error => {
        console.error('Network error', error);
      });
    }

    // 6. 초기 실행
    window.onload = function () {
      chatInit();
      document.querySelectorAll('.heart-icon').forEach(heartIcon => {
        attachHeartEvents(heartIcon);
      });
      window.currentChatId = document.getElementById('chat-form').dataset.chatId; // 현재 채팅 ID 저장
    };
  </script>
</body>
</html>

