{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Senpick 챗봇</title>
  <link rel="stylesheet" href="{% static 'css/stepper.css' %}">
  <link rel="stylesheet" href="{% static 'css/chat.css' %}">
</head>
<body>
  <div class="app-layout">
    {% include 'sidebar.html' %}
    <div class="main-content">
      <div class="chatbot-header">
        <h1>안녕하세요! {{ username }}님</h1>
        <p>오늘은 누구를 위한 선물을 고민하고 계신가요?</p>
      </div>
      <div class="chatbot-body">
        <div class="chat-window" id="chat-history">
          <!-- 카드/채팅 로그가 여기 누적됩니다 -->
        </div>
        <form class="chat-input-form" id="chat-form" autocomplete="off" style="display:none;">
          <div class="chat-input-wrap">
            <input type="text" id="user-input" placeholder="예: '친구 결혼 선물 5만원대 추천해줘'" />
            <button type="submit" class="chat-send-btn" aria-label="전송">
              <svg width="18" height="18" viewBox="0 0 16 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7 17C7 17.5523 7.44772 18 8 18C8.55228 18 9 17.5523 9 17L7 17ZM8.70711 0.292892C8.31658 -0.0976314 7.68342 -0.0976315 7.29289 0.292892L0.928933 6.65685C0.538408 7.04738 0.538408 7.68054 0.928933 8.07107C1.31946 8.46159 1.95262 8.46159 2.34315 8.07107L8 2.41421L13.6569 8.07107C14.0474 8.46159 14.6805 8.46159 15.0711 8.07107C15.4616 7.68054 15.4616 7.04738 15.0711 6.65685L8.70711 0.292892ZM8 17L9 17L9 1L8 1L7 1L7 17L8 17Z" fill="white"/>
              </svg>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <script>
    // 질문 데이터 (파일 업로드 단계 포함 예시)
    const stepData = [
      {
        title: "1/1",
        question: "대화내역 파일을 첨부해주세요",
        type: "file"
      }
    ];
    let currentStep = 0;
    const answers = [];

    function renderStep() {
      const data = stepData[currentStep];
      // 파일 첨부 카드 예시 (확장 가능)
      if (data.type === "file") {
        let html = `
          <div class="step-card step-card-file" id="step-card-${currentStep}">
            <form class="file-upload-form" enctype="multipart/form-data" onsubmit="return false;">
              <label class="file-dropzone">
                <input type="file" accept=".txt,.json" style="display:none;">
                <div class="file-drop-content">
                  <svg width="34" height="34" style="opacity:.3;margin-bottom:7px;" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21.51 12.488l-9.078 9.077a2.61 2.61 0 0 0 3.691 3.693l7.7-7.7a5.22 5.22 0 0 0-7.383-7.384l-7.701 7.701a7.83 7.83 0 0 0 11.078 11.077l9.077-9.078" stroke="#888" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  <div>대화내역 파일 첨부하기<br><span class="file-hint">(txt, json 파일, 1개만 첨부 가능)</span></div>
                </div>
              </label>
              <div class="file-drop-error" style="color:#e53a3a; font-size:15px; margin:8px 0 0 0; min-height:22px;"></div>
              <label class="step-option">
                <input type="checkbox" id="skip-checkbox" style="margin-right:10px;">
                건너뛰기
              </label>
              <button type="button" class="step-next-btn" id="start-btn">센픽과 대화 시작하기</button>
            </form>
          </div>
        `;
        document.getElementById('chat-history').insertAdjacentHTML('beforeend', html);

        // --- 파일 첨부/에러 표시/파일명 표시
        const fileInput = document.querySelector(`#step-card-${currentStep} input[type="file"]`);
        const fileDropContent = document.querySelector(`#step-card-${currentStep} .file-drop-content`);
        const fileDropzone = document.querySelector(`#step-card-${currentStep} .file-dropzone`);
        const errorBox = document.querySelector(`#step-card-${currentStep} .file-drop-error`);
        const skipCheckbox = document.getElementById('skip-checkbox');

        // 지원 확장자 검사 함수
        function isValidFile(file) {
          if (!file) return false;
          const name = file.name.toLowerCase();
          return name.endsWith('.txt') || name.endsWith('.json');
        }

        fileDropzone.onclick = function() { fileInput.click(); };

        fileInput.onchange = function(e) {
          fileDropzone.classList.remove('error');
          errorBox.textContent = '';
          if (this.files.length > 0) {
            if (!isValidFile(this.files[0])) {
              // 에러 처리
              fileDropzone.classList.add('error');
              errorBox.textContent = '지원하지 않는 파일형식 입니다.';
              fileInput.value = '';
              fileDropContent.innerHTML = `대화내역 파일 첨부하기<br><span class="file-hint">(txt, json 파일, 1개만 첨부 가능)</span>`;
              return;
            }
            fileDropContent.innerHTML = `<b>${this.files[0].name}</b> 업로드됨`;
            skipCheckbox.checked = false; // 파일 첨부하면 건너뛰기 해제
          } else {
            fileDropContent.innerHTML = `대화내역 파일 첨부하기<br><span class="file-hint">(txt, json 파일, 1개만 첨부 가능)</span>`;
          }
        };

        skipCheckbox.onchange = function() {
          if (skipCheckbox.checked && fileInput.files.length > 0) {
            fileInput.value = '';
            fileDropContent.innerHTML = `대화내역 파일 첨부하기<br><span class="file-hint">(txt, json 파일, 1개만 첨부 가능)</span>`;
            fileDropzone.classList.remove('error');
            errorBox.textContent = '';
          }
        };

        // 센픽과 대화 시작하기 버튼
        document.getElementById('start-btn').onclick = function() {
          const skipChecked = skipCheckbox.checked;
          if (!skipChecked && fileInput.files.length === 0) {
            errorBox.textContent = '파일을 첨부하거나, 건너뛰기를 체크해주세요!';
            fileDropzone.classList.add('error');
            return;
          }
          let msg = skipChecked
            ? "파일 첨부 없이 시작"
            : `[${fileInput.files[0].name}] 첨부, 센픽과 대화 시작!`;
          document.getElementById(`step-card-${currentStep}`).insertAdjacentHTML('afterend',
            `<div class="chat-msg user">${msg}</div>`);
          // ✅ 채팅 입력창 보이기
          document.getElementById('chat-form').style.display = 'block';
          setTimeout(() => {
            document.getElementById('chat-form').scrollIntoView({behavior:'smooth'});
          }, 200);
        };

        setTimeout(() => {
          document.getElementById('chat-history').scrollTop = document.getElementById('chat-history').scrollHeight;
        }, 50);

        return;
      }
      // ... (여기에 추가적인 질문 단계 render 가능)
    }

    // 채팅 입력
    function chatInit() {
      const chatForm = document.getElementById('chat-form');
      const chatHistory = document.getElementById('chat-history');
      chatForm.onsubmit = function(e) {
        e.preventDefault();
        const input = document.getElementById('user-input');
        if (input.value.trim() !== "") {
          chatHistory.insertAdjacentHTML(
            'beforeend',
            `<div class="chat-msg user">${input.value}</div>`
          );
          setTimeout(() => {
            chatHistory.insertAdjacentHTML(
              'beforeend',
              `<div class="chat-msg">아직 백엔드 연결 전입니다 :)</div>`
            );
            chatHistory.scrollTop = chatHistory.scrollHeight;
          }, 600);
          input.value = "";
          chatHistory.scrollTop = chatHistory.scrollHeight;
        }
      }
    }

    window.onload = function() {
      renderStep();
      chatInit();
    };
  </script>
</body>
</html>
