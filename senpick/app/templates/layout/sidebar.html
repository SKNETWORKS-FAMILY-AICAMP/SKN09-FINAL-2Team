{% load static %}
<div class="sidebar" id="sidebar">
  <!-- 메인: 검색, New Chat, Chat, 채팅리스트 -->
  <div class="sidebar-main">
    <!-- 상단 헤더 (브랜드/토글) -->
    <div class="sidebar-header">
      <img src="{% static 'images/top_logo.svg' %}" alt="Senpick Logo" class="logo-img">
      <button class="menu-btn tooltip" id="sidebar-toggle-btn" title="사이드바 접기">
        <span class="tooltip-text">사이드바 접기</span>
        <img src="{% static 'images/sidebar_toggle.png' %}" alt="사이드바 토글">
      </button>
    </div>
    <div class="divider-line"></div>
    <label class="search-row" id="sidebar-search-row">
      <img src="{% static 'images/search.svg' %}" alt="검색">
      <input id="sidebarSearch" type="text" placeholder="검색어를 입력해주세요.">
    </label>
    <div class="menu-btn-row" id="newchat-btn" onclick="location.href=`{% url 'chat' %}`">
      <img src="{% static 'images/plus.svg' %}" alt="새 채팅">
      <span class="btn-label">New Chat</span>
    </div>
    <div class="menu-btn-row selected" id="chat-btn" cursor="default;">
      <img src="{% static 'images/chat_logo.png' %}" alt="Chat">
      <span class="btn-label">Chat</span>
    </div>
    <ul class="chat-list"></ul>
    <div class="menu-btn-row" id="gift-btn" onclick="location.href=`{% url 'birth' %}`">
      <img src="{% static 'images/gift.svg' %}" alt="Gift">
      <span class="btn-label">Happy Birthday</span>
    </div>
  </div>
  <!-- 하단: 마이페이지/브랜드바 -->
  <div class="sidebar-bottom">
    <div class="divider-line"></div>
    <div class="brand-bar">
      <a href="{% url 'mypage' %}" style="display: flex; align-items: center; text-decoration: none;">
        <img src="{% static 'images/bottom_logo.svg' %}" alt="Brand" class="brand-logo">
        <span class="brand-label">유지니어스</span>
      </a>
      <a href="{% url 'login' %}" class="brand-link tooltip" title="로그아웃">
        <span class="tooltip-text">로그아웃</span>
        <img src="{% static 'images/logout.svg' %}" alt="로그아웃">
      </a>
    </div>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    // 요소 참조 변수 선언
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('sidebar-toggle-btn');
    const searchRow = document.getElementById('sidebar-search-row');
    const chathistory = document.querySelector('.chat-list');
    const logoImg = document.querySelector('.logo-img');
    const brandLink = document.querySelector('.brand-link');
    const brandBar = document.querySelector('.brand-bar');

    let loginState = true; // 로그인 상태

    // 접힘/펼침 상태에 따른 토글 버튼 표시
    function showToggleIfOpen() {
      toggleBtn.style.display = sidebar.classList.contains('mini') ? 'none' : '';
    }

    // 채팅 기록 불러오기 및 렌더링
    fetch("/chat/history")
      .then(res => res.ok ? res.json() : Promise.reject("채팅 기록을 가져오는 데 실패했습니다."))
      .then(data => {
        if (data && Array.isArray(data.chat_history)) {
          const chatElements = data.chat_history.map(chat => {
            const li = document.createElement('li');
            const span = document.createElement('span');
            span.className = 'chat-title';
            span.textContent = chat.title;

            li.appendChild(span);
            li.addEventListener('click', () => {
              document.querySelector('.chat-list li.selected')?.classList.remove('selected');
              li.classList.add('selected');
            });

            return li;
          });

          chathistory.append(...chatElements);
          chathistory.firstElementChild?.classList.add('selected');
        }
      })
      .catch(error => console.error("채팅 기록을 가져오는 중 오류 발생:", error));

    // 초기 상태 설정
    showToggleIfOpen();

    // 로고 클릭 시 sidebar 열기
    logoImg.addEventListener('click', () => {
      if (sidebar.classList.contains('mini')) {
        sidebar.classList.remove('mini');
        showToggleIfOpen();
      }
    });

    // 검색 영역 클릭 시 sidebar 열기
    searchRow.addEventListener('click', () => {
      if (sidebar.classList.contains('mini')) {
        sidebar.classList.remove('mini');
        showToggleIfOpen();
        // sidebarSearch.focus(); // 주석 처리된 부분 (sidebarSearch 변수 없음 주의)
      }
    });

    // 토글 버튼 클릭 시 sidebar 접기
    toggleBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      sidebar.classList.add('mini');
      showToggleIfOpen();
    });

    // sidebar 클래스 변경 감지
    const observer = new MutationObserver(showToggleIfOpen);
    observer.observe(sidebar, { attributes: true, attributeFilter: ['class'] });

    // 브랜드 링크 클릭 시 로그인/로그아웃 토글
    brandLink.addEventListener('click', (e) => {
      // e.preventDefault(); // 필요 시 주석 해제
      if (loginState) {
        // 로그아웃 처리
        loginState = false;
        brandBar.querySelector('.brand-label').textContent = '로그인';
        brandBar.querySelector('img').src = "{% static 'images/bottom_logo_white.svg' %}";
      } else {
        // 로그인 처리
        loginState = true;
        brandBar.querySelector('.brand-label').textContent = '유지니어스';
        brandBar.querySelector('img').src = "{% static 'images/bottom_logo.svg' %}";
      }
    });
  });
</script>